name: Generate GitHub Metrics

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p stats

      # GitHub Stats - Header and repository info
      - name: Generate GitHub Stats
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/github-stats.svg
          base: header, repositories
          base_indepth: yes
          repositories_forks: yes
          config_timezone: Asia/Manila
          output_action: none

      # Top Languages with private repo support
      - name: Generate Top Languages
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/top-langs.svg
          base: ""
          plugin_languages: yes
          plugin_languages_indepth: yes
          plugin_languages_limit: 8
          plugin_languages_details: bytes-size, percentage
          plugin_languages_analysis_timeout: 30
          plugin_languages_analysis_timeout_repositories: 15
          plugin_languages_categories: programming, markup
          plugin_languages_recent_load: 500
          plugin_languages_recent_days: 365
          config_timezone: Asia/Manila
          output_action: none

      # Isometric Calendar - Replaces 3D contributions and shows streaks
      - name: Generate Isometric Calendar
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/isocalendar.svg
          base: ""
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          config_timezone: Asia/Manila
          output_action: none

      # Achievements - Replaces trophies
      - name: Generate Achievements
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/achievements.svg
          base: ""
          plugin_achievements: yes
          plugin_achievements_display: compact
          plugin_achievements_threshold: C
          plugin_achievements_secrets: yes
          config_timezone: Asia/Manila
          output_action: none

      # Habits - Coding patterns and activity
      - name: Generate Habits
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/habits.svg
          base: ""
          plugin_habits: yes
          plugin_habits_from: 500
          plugin_habits_days: 30
          plugin_habits_facts: yes
          plugin_habits_charts: yes
          plugin_habits_charts_type: classic
          config_timezone: Asia/Manila
          output_action: none

      # Calendar - Full contribution history
      - name: Generate Calendar
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/calendar.svg
          base: ""
          plugin_calendar: yes
          plugin_calendar_limit: 3
          config_timezone: Asia/Manila
          output_action: none

      # Full profile overview - Combined view
      - name: Generate Full Profile
        uses: lowlighter/metrics@latest
        with:
          user: OliverRhyme
          token: ${{ secrets.GH_TOKEN }}
          filename: stats/profile.svg
          base: header, activity, community, repositories, metadata
          base_indepth: yes
          repositories_forks: yes
          plugin_lines: yes
          plugin_lines_history_limit: 1
          plugin_lines_repositories_limit: 4
          plugin_lines_sections: base
          config_timezone: Asia/Manila
          output_action: none

      - name: Copy metrics output to stats directory
        run: |
          ls -laR /metrics_renders/ || true
          cp -r /metrics_renders/stats/* stats/ 2>/dev/null || cp /metrics_renders/*.svg stats/ 2>/dev/null || true
          ls -la stats/

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stats/
          git diff --quiet && git diff --staged --quiet || git commit -m "Update GitHub metrics"
          git pull --rebase origin main
          git push

  # Snake animation - kept separate as lowlighter/metrics doesn't have this feature
  snake-animation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: OliverRhyme
          github_token: ${{ secrets.GH_TOKEN }}
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # GitLab Pac-Man - kept separate as it's GitLab-specific
  gitlab-pacman:
    runs-on: ubuntu-latest
    needs: github-metrics
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull --rebase origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate Pac-Man SVG
        run: |
          npx pacman-contribution-graph \
            --username OliverRhyme \
            --platform gitlab \
            --gameTheme gitlab-dark \
            -o pacman-gitlab.svg

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pacman-gitlab.svg
          git diff --quiet && git diff --staged --quiet || git commit -m "Update GitLab Pac-Man contribution graph"
          git pull --rebase origin main
          git push
